<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test app</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        .container { 
            max-width: 900px;
            margin-top: 50px; 
        }
        .hidden { display: none; }
        @media (max-width: 991.98px) {
            .container {
                max-width: 98vw;
            }
        }
        td, th {
            white-space: normal !important;
            word-break: break-word;
        }
        .dashboard-card {
            background: #fff;
            border-radius: 1rem;
            box-shadow: 0 2px 16px rgba(0,0,0,0.07);
            padding: 2rem 1rem 1.5rem 1rem;
            margin-bottom: 2rem;
        }
        .dashboard-table thead th {
            position: sticky;
            top: 0;
            background: #f8f9fa;
            z-index: 1;
        }
        .dashboard-table tbody tr:hover {
            background: #e9ecef;
        }
        .dashboard-actions .btn {
            min-width: 2.5rem;
        }
        #loginEmail, #loginPassword {
            max-width: 500px;
        }
        @media (max-width: 575.98px) {
            .container {
                margin-top: auto;
            }
            .dashboard-actions {
                flex-wrap: wrap;
                justify-content: center;
            }
            .dashboard-actions .btn {
                flex: 1 1 auto;
                margin-bottom: 0.5rem;
            }
            .dashboard-table thead th.text-end {
                display: none; 
            }
            .dashboard-table tbody tr td {
                border-bottom: none; 
            }
            .dashboard-table tbody tr.d-sm-none td {
                border-bottom: 1px solid #dee2e6; 
            }
            .dashboard-card {
                border: none; 
                box-shadow: none; 
                padding: 0;
                margin: 0.5rem 0; 
            }
        }
        .thank-you-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            text-align: center;
            background-color: #f8f9fa;
        }
        .thank-you-screen h2 {
            font-size: 2rem;
            margin-bottom: 1rem;
        }
        .thank-you-screen p {
            font-size: 1.2rem;
            margin-bottom: 2rem;
        }
        .thank-you-screen .btn {
            font-size: 1rem;
            padding: 0.5rem 1rem;
        }

        /* Candidate Form Styling */
        #applyForm {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        #applyForm h3 {
            color: #343a40;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        #applyForm label {
            font-weight: 500;
            color: #495057;
        }

        #applyForm .form-text {
            font-size: 0.9rem;
            color: #6c757d;
        }

        #applyForm .form-label span.text-danger {
            color: #dc3545;
            font-weight: bold;
        }

        #applyForm .form-control,
        #applyForm .form-select {
            border: 1px solid #ced4da;
            border-radius: 4px;
            transition: border-color 0.3s ease;
        }

        #applyForm .form-control:focus,
        #applyForm .form-select:focus {
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        #applyForm .invalid-feedback {
            font-size: 0.85rem;
            color: #dc3545;
        }

        #applyForm .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        #applyForm .btn-primary:hover {
            background-color: #0056b3;
            border-color: #004085;
        }

        #applyForm .btn-secondary {
            background-color: #6c757d;
            border-color: #6c757d;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        #applyForm .btn-secondary:hover {
            background-color: #5a6268;
            border-color: #545b62;
        }

        #applyForm .section-title {
            font-size: 1.25rem;
            font-weight: bold;
            color: #343a40;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #007bff;
            padding-bottom: 0.5rem;
        }

        #applyForm .mb-3 {
            margin-bottom: 1.5rem;
        }

        #applyForm textarea {
            resize: none;
        }

        #applyForm .hidden {
            display: none;
        }
        
        .form-check-label {
            display: inline;
        }

        /* Improved Candidate Details Layout for Consistency */
        #tenantDetailsContent {
            max-width: 700px;
            margin: 0 auto;
        }
        .tenant-details-card {
            background: #fff;
            border-radius: 1rem;
            box-shadow: 0 2px 16px rgba(0,0,0,0.07);
            padding: 2rem 1.5rem 1.5rem 1.5rem;
            margin-bottom: 2rem;
        }
        .tenant-details-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }
        #candidateScoreBadge {
            font-size: 1.1rem;
            padding: 0.5em 1.2em;
            margin-bottom: 0.5rem;
            display: inline-block;
        }
        .details-section {
            margin-bottom: 2rem;
            background: #f8f9fa;
            border-radius: 0.5rem;
            padding: 1.25rem 1rem 1rem 1rem;
            box-shadow: 0 1px 4px rgba(0,0,0,0.04);
        }
        .details-section h3 {
            font-size: 1.15rem;
            font-weight: 600;
            color: #0d6efd;
            margin-bottom: 1rem;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 0.25rem;
        }
        .details-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 0.5rem 1.5rem;
        }
        .detail-item {
            display: contents;
        }
        .detail-label {
            font-weight: 500;
            color: #495057;
            padding: 0.5rem 0;
            text-align: right;
            border-right: 2px solid #e9ecef;
            background: #f1f3f5;
            border-radius: 0.25rem 0 0 0.25rem;
            min-width: 120px;
        }
        .detail-value {
            padding: 0.5rem 0 0.5rem 1rem;
            color: #212529;
            background: #fff;
            border-radius: 0 0.25rem 0.25rem 0;
            border-left: 2px solid #e9ecef;
            min-width: 120px;
            word-break: break-word;
        }
        @media (max-width: 600px) {
            .tenant-details-card {
                padding: 1rem 0.5rem;
            }
            .details-section {
                padding: 1rem 0.5rem 0.5rem 0.5rem;
            }
            .details-grid {
                grid-template-columns: 1fr;
            }
            .detail-label, .detail-value {
                border: none;
                text-align: left;
                padding-left: 0;
            }
            .detail-value {
                padding-top: 0;
            }
        }

        /* Responsive Candidate Table */
        @media (max-width: 800px) {
            #tenantCandidatesContent table thead {
                display: none;
            }
            #tenantCandidatesContent table tbody tr {
                display: block;
                margin-bottom: 1.5rem;
                border: 1px solid #dee2e6;
                border-radius: 0.5rem;
                box-shadow: 0 1px 4px rgba(0,0,0,0.04);
                background: #fff;
                padding: 0.5rem 0.75rem;
            }
            #tenantCandidatesContent table tbody td {
                display: flex;
                width: 100%;
                justify-content: space-between;
                align-items: center;
                border: none !important;
                padding: 0.5rem 0;
                font-size: 1rem;
            }
            #tenantCandidatesContent table tbody td:before {
                content: attr(data-label);
                font-weight: 600;
                color: #495057;
                flex: 0 0 55%;
                text-align: left;
                padding-right: 1rem;
            }
            #tenantCandidatesContent table tbody td:last-child {
                justify-content: flex-end;
            }
        }
        @media (max-width: 500px) {
            #tenantCandidatesContent table tbody tr {
                padding: 0.25rem 0.25rem;
            }
            #tenantCandidatesContent table tbody td {
                font-size: 0.97rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Register Screen -->
        <div id="registerScreen" class="hidden">
            <h2>Register</h2>
            <form id="registerForm" novalidate>
                <div class="mb-3">
                    <label for="email" class="form-label">Email address</label>
                    <input type="email" class="form-control" id="email" required>
                    <div class="invalid-feedback">Please provide a valid email address.</div>
                </div>
                <div class="mb-3">
                    <label for="password" class="form-label">Password</label>
                    <input type="password" class="form-control" id="password" required>
                    <div class="invalid-feedback">Please provide a password.</div>
                </div>
                <div class="mb-3">
                    <label for="confirmPassword" class="form-label">Confirm Password</label>
                    <input type="password" class="form-control" id="confirmPassword" required>
                    <div class="invalid-feedback">Passwords must match.</div>
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="termsCheck" required>
                    <label class="form-check-label" for="termsCheck">
                        I agree to the Terms & Privacy Policy
                    </label>
                    <div class="invalid-feedback">You must agree to the terms.</div>
                </div>
                <div class="mb-3">
                    <div id="captchaContainer"></div>
                </div>
                <button type="button" class="btn btn-primary" onclick="register()">Register</button>
                <button type="button" class="btn btn-secondary" onclick="showLoginScreen()">Cancel</button>
            </form>
        </div>

        <!-- Confirm Email Screen -->
        <div id="confirmEmailScreen" class="hidden">
            <h2>Confirm Email</h2>
            <form id="confirmEmailForm" novalidate>
                <div class="mb-3">
                    <label for="confirmEmailInput" class="form-label">Email</label>
                    <input type="email" class="form-control" id="confirmEmailInput" required>
                    <div class="invalid-feedback">Please provide your email address.</div>
                </div>
                <div class="mb-3">
                    <label for="confirmationCode" class="form-label">Confirmation Code</label>
                    <input type="text" class="form-control" id="confirmationCode" required>
                    <div class="invalid-feedback">Please provide the confirmation code.</div>
                </div>
                <button type="button" class="btn btn-primary" onclick="handleConfirmEmail()">Confirm</button>
                <button type="button" class="btn btn-secondary" onclick="showLoginScreen()">Cancel</button>
            </form>
        </div>

        <!-- Login Screen -->
        <div id="loginScreen">
            <h2>Login</h2>
            <form id="loginForm" novalidate>
                <div class="mb-3">
                    <label for="loginEmail" class="form-label">Email</label>
                    <input type="email" class="form-control" id="loginEmail"required>
                    <div class="invalid-feedback">Please provide a valid email address.</div>
                </div>
                <div class="mb-3">
                    <label for="loginPassword" class="form-label">Password</label>
                    <input type="password" class="form-control" id="loginPassword" required>
                    <div class="invalid-feedback">Please provide your password.</div>
                </div>
                <button type="button" class="btn btn-primary" onclick="login()">Log In</button>
            </form>
            <div class="mt-3">
                <button class="btn btn-link" onclick="showRegisterScreen()">Register</button>
                <button class="btn btn-link" onclick="showForgotPasswordScreen()">Forgot Password?</button>
                <button class="btn btn-link" onclick="showConfirmEmailScreen()">* Confirm Email</button>
                <button class="btn btn-link" onclick="showResetPasswordScreen()">* Reset Password</button>
            </div>
        </div>

        <!-- Forgot Password Screen -->
        <div id="forgotPasswordScreen" class="hidden">
            <h2>Forgot Password</h2>
            <form id="forgotPasswordForm" novalidate>
                <div class="mb-3">
                    <label for="forgotEmail" class="form-label">Email</label>
                    <input type="email" class="form-control" id="forgotEmail" required>
                    <div class="invalid-feedback">Please provide your email address.</div>
                </div>
                <button type="button" class="btn btn-primary" onclick="sendResetCode()">Send Reset Code</button>
                <button type="button" class="btn btn-secondary" onclick="showLoginScreen()">Cancel</button>
            </form>
        </div>

        <!-- Reset Password Screen -->
        <div id="resetPasswordScreen" class="hidden">
            <h2>Reset Password</h2>
            <form id="resetPasswordForm" novalidate>
                <div class="mb-3">
                    <label for="resetEmail" class="form-label">Email</label>
                    <input type="email" class="form-control" id="resetEmail" required>
                    <div class="invalid-feedback">Please provide your email address.</div>
                </div>
                <div class="mb-3">
                    <label for="resetCode" class="form-label">Reset Code</label>
                    <input type="text" class="form-control" id="resetCode" required>
                    <div class="invalid-feedback">Please provide the reset code.</div>
                </div>
                <div class="mb-3">
                    <label for="newPassword" class="form-label">New Password</label>
                    <input type="password" class="form-control" id="newPassword" required>
                    <div class="invalid-feedback">Please provide a new password.</div>
                </div>
                <div class="mb-3">
                    <label for="confirmNewPassword" class="form-label">Confirm New Password</label>
                    <input type="password" class="form-control" id="confirmNewPassword" required>
                    <div class="invalid-feedback">Passwords must match.</div>
                </div>
                <button type="button" class="btn btn-primary" onclick="resetPassword()">Reset Password</button>
                <button type="button" class="btn btn-secondary" onclick="showLoginScreen()">Cancel</button>
            </form>
        </div>

        <!-- Dashboard Screen -->
        <div id="dashboardScreen" class="hidden">
            <div class="dashboard-card">
                <div class="d-flex flex-column flex-sm-row justify-content-between align-items-sm-center mb-3 gap-2">
                    <button class="btn btn-success dashboard-header-btn" onclick="showAddPropertyScreen()">
                        <i class="bi bi-plus-lg"></i> Add New Property
                    </button>
                    <span id="usageMeter" class="badge bg-info text-dark align-self-start align-self-sm-center mt-2 mt-sm-0">1 of 1 active listings used</span>
                </div>
                <div class="mb-2">
                    <small class="text-muted">Want to activate more? <a href="#">Upgrade here</a></small>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle dashboard-table">
                        <thead>
                            <tr>
                                <th style="width: 30%;">Address</th>
                                <th style="width: 10%;">Status</th>
                                <th style="width: 15%;">Candidates</th>
                                <th class="text-end" style="width: 35%;">
                                </th>
                            </tr>
                        </thead>
                        <tbody id="propertiesTableBody">
                            <!-- Properties will be rendered here -->
                        </tbody>
                    </table>
                </div>
                <button type="button" class="btn btn-secondary mt-3" onclick="logout()">Log Out</button>
            </div>
        </div>

        <!-- Public Property Screen -->
        <div id="publicPropertyScreen" class="hidden">
            <!-- Property Info Section -->
            <div id="publicPropertyContent" class="card mb-4 border-primary">
                <div class="card-header bg-primary text-white">
                    <h4 class="card-title mb-0" id="propertyAddress">Property Address</h4>
                </div>
                <div class="card-body">
                    <p class="card-text" id="propertyDescription">Property description will be displayed here.</p>
                    <p class="card-text">
                        <a href="#" target="_blank" id="propertyLink" class="text-decoration-none text-primary">View Listing</a>
                    </p>
                    <p class="card-text">
                        <small class="text-muted">Available: <span id="propertyAvailability">Availability date</span></small>
                    </p>
                </div>
            </div>

            <form id="applyForm" novalidate class="mt-4">
                <h3>Rental Application Form</h3>
                <p>We’ll ask a few basic questions to help the landlord understand if you’re a good fit for the rental.</p>
                <p><strong>Please do not enter any of the following:</strong></p>
                <ul>
                    <li>Full or partial names</li>
                    <li>Specific home or work addresses</li>
                    <li>Social Insurance Number (SIN) or passport number</li>
                    <li>Credit card or banking information</li>
                </ul>
                <p class="text-muted">This form is anonymous and lightweight. While we take reasonable steps to protect your data, we intentionally avoid collecting or storing sensitive personal information at this stage.</p>

                <!-- Section: Basic Information -->
                <div class="section-title">Contact</div>
                <div class="mb-3">
                    <label for="applicantEmail" class="form-label">Email Address <span class="text-danger">*</span></label>
                    <input type="email" class="form-control" id="applicantEmail" required>
                    <div class="form-text">Your email is not visible to the landlord and will be used for automated communication regarding your application status.</div>
                    <div class="invalid-feedback">Please provide a valid email address.</div>
                </div>
                <div class="mb-3">
                    <input type="checkbox" id="consentContact" required>
                    <label for="consentContact" class="form-check-label">I consent to being contacted at the email address provided regarding my rental application.</label>
                    <div class="invalid-feedback">You must consent to being contacted.</div>
                </div>
                <div class="mb-3">
                    <input type="checkbox" id="consentNews">
                    <label for="consentNews" class="form-check-label">I consent to receive occasional communication about news and new features of this website.</label>
                </div>

                <div class="section-title">Lifestyle</div>
                <div class="mb-3">
                    <label for="moveInDate" class="form-label">When are you planning to move in? <span class="text-danger">*</span></label>
                    <input type="date" class="form-control" id="moveInDate" required>
                    <div class="invalid-feedback">Please provide a valid move-in date. It cannot be in the past.</div>
                </div>
                <div class="mb-3">
                    <label for="occupants" class="form-label">How many people will live in the unit? <span class="text-danger">*</span></label>
                    <select class="form-select" id="occupants" required>
                        <option value="">Select...</option>
                        <option value="Just me">Just me</option>
                        <option value="2 people">2 people</option>
                        <option value="3 people">3 people</option>
                        <option value="4 people">4 people</option>
                        <option value="5 or more people">5 or more people</option>
                    </select>
                    <div class="invalid-feedback">Please select the number of occupants.</div>
                </div>
                <div class="mb-3">
                    <label for="smokers" class="form-label">Do you or anyone in your household smoke? <span class="text-danger">*</span></label>
                    <select class="form-select" id="smokers" required>
                        <option value="">Select...</option>
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                    </select>
                    <div class="invalid-feedback">Please specify if there are smokers in the household.</div>
                </div>
                <div class="mb-3">
                    <label for="pets" class="form-label">Do you have any pets? <span class="text-danger">*</span></label>
                    <select class="form-select" id="pets" required>
                        <option value="">Select...</option>
                        <option value="No">No</option>
                        <option value="Yes — Small">Yes — Small (e.g., cat, small dog, fish)</option>
                        <option value="Yes — Large">Yes — Large (e.g., large dog)</option>
                        <option value="Yes — Exotic">Yes — Exotic (e.g., rat, rabbit, reptile)</option>
                    </select>
                    <div class="invalid-feedback">Please specify if you have pets.</div>
                </div>
                <div class="mb-3 hidden" id="petDetailsContainer">
                    <label for="petDetails" class="form-label">Please describe number and type of your pets: <span class="text-danger">*</span></label>
                    <textarea class="form-control" id="petDetails" rows="3" required></textarea>
                    <div class="invalid-feedback">Please provide details about your pets.</div>
                </div>

                <!-- Section: Rental history -->
                <div class="mb-3">
                    <label for="housingSituation" class="form-label">What is your current housing situation? <span class="text-danger">*</span></label>
                    <select class="form-select" id="housingSituation" required>
                        <option value="">Select...</option>
                        <option value="Renting">Renting</option>
                        <option value="Living with family">Living with family</option>
                        <option value="Staying with friends">Staying with friends</option>
                        <option value="Own my home">Own my home</option>
                        <option value="Temporary housing">Temporary housing (e.g. sublet, hotel)</option>
                        <option value="Other">Other (please specify)</option>
                    </select>
                    <div class="invalid-feedback">Please select your current housing situation.</div>
                </div>
                <div class="mb-3">
                    <label for="residenceDuration" class="form-label">How long have you lived at your current residence? <span class="text-danger">*</span></label>
                    <select class="form-select" id="residenceDuration" required>
                        <option value="">Select...</option>
                        <option value="Less than 6 months">Less than 6 months</option>
                        <option value="6–12 months">6–12 months</option>
                        <option value="1–3 years">1–3 years</option>
                        <option value="3-5 years">3-5 years</option>
                        <option value="5-10 years">5-10 years</option>
                        <option value="Over 10 years">Over 10 years</option>
                    </select>
                    <div class="invalid-feedback">Please select how long you have lived at your current residence.</div>
                </div>
                <div class="mb-3">
                    <label for="reasonForMoving" class="form-label">Why are you moving? <span class="text-danger">*</span></label>
                    <textarea class="form-control" id="reasonForMoving" rows="3" required></textarea>
                    <div class="invalid-feedback">Please provide details about your move.</div>
                </div>
                <div class="mb-3">
                    <label for="privateLandlord" class="form-label">Have you rented from a private landlord before? <span class="text-danger">*</span></label>
                    <select class="form-select" id="privateLandlord" required>
                        <option value="">Select...</option>
                        <option value="Yes">Yes</option>
                        <option value="No (first-time renter)">No (first-time renter)</option>
                    </select>
                    <div class="invalid-feedback">Please specify if you have rented from a private landlord before.</div>
                </div>

                <!-- Sub-section: Rental History Details -->
                <div id="rentalHistoryDetails" class="hidden">
                    <div class="mb-3">
                        <label for="rentalUnits" class="form-label">How many rental units have you lived in within the past 5 years? <span class="text-danger">*</span></label>
                        <select class="form-select" id="rentalUnits" required>
                            <option value="">Select...</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="More than 5">More than 5</option>
                        </select>
                        <div class="invalid-feedback">Please select the number of rental units.</div>
                    </div>
                    <div class="mb-3">
                        <label for="rentDifficulty" class="form-label">Have you ever had difficulty paying rent on time in the past 2 years? <span class="text-danger">*</span></label>
                        <select class="form-select" id="rentDifficulty" required>
                            <option value="">Select...</option>
                            <option value="No">No</option>
                            <option value="Yes">Yes</option>
                        </select>
                        <div class="invalid-feedback">Please specify if you have had difficulty paying rent.</div>
                    </div>
                    <div class="mb-3" id="rentDifficultyDetailsContainer" style="display: none;">
                        <label for="rentDifficultyDetails" class="form-label">Please briefly explain: <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="rentDifficultyDetails" rows="3" required></textarea>
                        <div class="invalid-feedback">Please provide details about your rent difficulty.</div>
                    </div>
                    <div class="mb-3">
                        <label for="tenancyNotice" class="form-label">Have you ever received a formal notice from a landlord to end a tenancy? <span class="text-danger">*</span></label>
                        <select class="form-select" id="tenancyNotice" required>
                            <option value="">Select...</option>
                            <option value="No">No</option>
                            <option value="Yes">Yes</option>
                        </select>
                        <div class="invalid-feedback">Please specify if you have received a formal notice.</div>
                    </div>
                    <div class="mb-3" id="tenancyNoticeDetailsContainer" style="display: none;">
                        <label for="tenancyNoticeDetails" class="form-label">Please briefly explain: <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="tenancyNoticeDetails" rows="3" required></textarea>
                        <div class="invalid-feedback">Please provide details about the notice.</div>
                    </div>
                    <div class="mb-3">
                        <label for="rentalDispute" class="form-label">Have you ever been involved in a rental dispute that required mediation, tribunal, or legal action? <span class="text-danger">*</span></label>
                        <select class="form-select" id="rentalDispute" required>
                            <option value="">Select...</option>
                            <option value="No">No</option>
                            <option value="Yes">Yes</option>
                        </select>
                        <div class="invalid-feedback">Please specify if you have been involved in a rental dispute.</div>
                    </div>
                    <div class="mb-3" id="rentalDisputeDetailsContainer" style="display: none;">
                        <label for="rentalDisputeDetails" class="form-label">Please briefly explain: <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="rentalDisputeDetails" rows="3" required></textarea>
                        <div class="invalid-feedback">Please provide details about the dispute.</div>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="businessActivity" class="form-label">Do you plan to operate any business or commercial activity from the rental property? <span class="text-danger">*</span></label>
                    <select class="form-select" id="businessActivity" required>
                        <option value="">Select...</option>
                        <option value="No">No</option>
                        <option value="Yes">Yes</option>
                    </select>
                    <div class="invalid-feedback">Please specify if you plan to operate a business or commercial activity.</div>
                </div>
                <div class="mb-3" id="businessActivityDetailsContainer" style="display: none;">
                    <label for="businessActivityDetails" class="form-label">Please briefly explain: <span class="text-danger">*</span></label>
                    <textarea class="form-control" id="businessActivityDetails" rows="3" required></textarea>
                    <div class="invalid-feedback">Please provide details about your business activity.</div>
                </div>
                <div class="mb-3">
                    <label for="vehicles" class="form-label">How many vehicles do you plan to park at the property? <span class="text-danger">*</span></label>
                    <select class="form-select" id="vehicles" required>
                        <option value="">Select...</option>
                        <option value="None">None</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="More than 4">More than 4</option>
                    </select>
                    <div class="invalid-feedback">Please specify the number of vehicles you plan to park.</div>
                </div>
                <div class="mb-3">
                    <label for="specialVehicles" class="form-label">Do you own any vehicles that require special storage or parking (e.g., motorcycle, boat, RV, trailer)?</label>
                    <select class="form-select" id="specialVehicles" required>
                        <option value="">Select...</option>
                        <option value="None">None</option>
                        <option value="Yes — Motorcycle">Yes — Motorcycle</option>
                        <option value="Yes — Boat">Yes — Boat</option>
                        <option value="Yes — RV or Trailer">Yes — RV or Trailer</option>
                        <option value="Yes — Other">Yes — Other</option>
                    </select>
                    <div class="invalid-feedback">Please specify if you own any special vehicles.</div>
                </div>
                <div class="mb-3" id="specialVehiclesDetailsContainer" style="display: none;">
                    <label for="specialVehiclesDetails" class="form-label">Please briefly explain: <span class="text-danger">*</span></label>
                    <textarea class="form-control" id="specialVehiclesDetails" rows="3" required></textarea>
                    <div class="invalid-feedback">Please provide details about your special vehicles.</div>
                </div>
                <div class="section-title">Financials</div>
                <div class="mb-3">
                    <label for="grossIncome" class="form-label">What is your approximate gross monthly income? <span class="text-danger">*</span></label>
                    <select class="form-select" id="grossIncome" required>
                        <option value="">Select...</option>
                        <option value="Under $1000">Under $1000</option>
                        <option value="$1000 - $2000">$1000 - $2000</option>
                        <option value="$2000 - $3000">$2000 - $3000</option>
                        <option value="$3000 - $4000">$3000 - $4000</option>
                        <option value="$5000 - $6000">$5000 - $6000</option>
                        <option value="$7000 - $8000">$7000 - $8000</option>
                        <option value="$8000 - $9000">$8000 - $9000</option>
                        <option value="$9000 - $10000">$9000 - $10000</option>
                        <option value="Over $10000">Over $10000</option>
                    </select>
                    <div class="invalid-feedback">Please select your gross monthly income.</div>
                </div>
                <div class="mb-3">
                    <label for="employmentStatus" class="form-label">What is your current employment status? <span class="text-danger">*</span></label>
                    <select class="form-select" id="employmentStatus" required>
                        <option value="">Select...</option>
                        <option value="Employed Full-Time">Employed Full-Time</option>
                        <option value="Employed Part-Time">Employed Part-Time</option>
                        <option value="Self-Employed">Self-Employed</option>
                        <option value="Unemployed">Unemployed</option>
                        <option value="Retired">Retired</option>
                        <option value="Student">Student</option>
                    </select>
                    <div class="invalid-feedback">Please select your employment status.</div>
                </div>

                <!-- Sub-section: Employment details -->
                <div id="employmentDetails" style="display: none;">
                    <div class="mb-3">
                        <label for="profession" class="form-label">What is your current profession, field of work, or study? <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="profession" required>
                        <div class="invalid-feedback">Please provide your profession or field of work.</div>
                    </div>
                    <div class="mb-3">
                        <label for="employmentDuration" class="form-label">How long have you been with your current employer (or running your business)? <span class="text-danger">*</span></label>
                        <select class="form-select" id="employmentDuration" required>
                            <option value="">Select...</option>
                            <option value="Less than 6 months">Less than 6 months</option>
                            <option value="6–12 months">6–12 months</option>
                            <option value="1–3 years">1–3 years</option>
                            <option value="3-5 years">3-5 years</option>
                            <option value="5-10 years">5-10 years</option>
                            <option value="Over 10 years">Over 10 years</option>
                        </select>
                        <div class="invalid-feedback">Please select the duration of your employment.</div>
                    </div>
                </div>

                <div class="section-title">Summary</div>
                <div class="mb-3">
                    <label for="additionalInfo" class="form-label">Is there anything else you would like to share that might support your application?</label>
                    <textarea class="form-control" id="additionalInfo" rows="3"></textarea>
                </div>
                <div class="mb-3">
                    <label for="creditConsent" class="form-label">Do you consent to a credit, public records, or background check if requested at a later stage in the process? <span class="text-danger">*</span></label>
                    <select class="form-select" id="creditConsent" required>
                        <option value="">Select...</option>
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                    </select>
                    <div class="form-text">Your response helps the landlord understand how you'd prefer to proceed and may affect the application, depending on the landlord’s screening requirements.</div>
                    <div class="invalid-feedback">Please specify your consent preference.</div>
                </div>

                <div class="mb-3">
                    <input type="checkbox" id="declaration1" required>
                    <label for="declaration1" class="form-check-label">I declare that the information I provided is true and complete to the best of my knowledge.</label>
                    <div class="invalid-feedback">You must agree to this declaration.</div>
                </div>
                <div class="mb-3">
                    <input type="checkbox" id="declaration2" required>
                    <label for="declaration2" class="form-check-label">I understand that providing false information may result in my application being declined.</label>
                    <div class="invalid-feedback">You must agree to this declaration.</div>
                </div>

                <div id="applyFormErrors" class="text-danger mb-3 hidden"></div>
                <button type="button" class="btn btn-primary" onclick="submitApplication()">Submit Application</button>
            </form>
        </div>

        <!-- Add/Edit Property Screen -->
        <div id="addPropertyScreen" class="hidden">
            <h2 id="propertyFormTitle">Add New Property</h2>
            <form id="addPropertyForm" novalidate>
                <input type="hidden" id="property_id">
                <div class="mb-3">
                    <label for="property_address" class="form-label">Address <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="property_address" required>
                    <div class="invalid-feedback">Please provide an address.</div>
                </div>
                <div class="mb-3">
                    <label for="property_description" class="form-label">Description <span class="text-danger">*</span></label>
                    <textarea class="form-control" id="property_description" rows="3" required></textarea>
                    <div class="invalid-feedback">Please provide a description.</div>
                </div>
                <div class="mb-3">
                    <label for="property_link" class="form-label">Link (Optional)</label>
                    <input type="url" class="form-control" id="property_link">
                    <div class="invalid-feedback">Please provide a valid link.</div>
                </div>
                <div class="mb-3">
                    <label for="property_availability" class="form-label">Availability Date <span class="text-danger">*</span></label>
                    <input type="date" class="form-control" id="property_availability" required>
                    <div class="invalid-feedback">Please provide the availability date.</div>
                </div>
                <div class="mb-3">
                    <label for="property_rent" class="form-label">Rent ($) <span class="text-danger">*</span></label>
                    <input type="number" class="form-control" id="property_rent" required>
                    <div class="invalid-feedback">Please provide the rent amount.</div>
                </div>
                <button type="button" class="btn btn-primary" onclick="saveProperty()">Save</button>
                <button type="button" class="btn btn-secondary" onclick="showDashboardScreen()">Cancel</button>
            </form>
        </div>

        <!-- Tenant Candidates Screen -->
        <div id="tenantCandidatesScreen" class="hidden">
            <div class="dashboard-card">
                <h2 class="mb-4">Tenant Candidates</h2>
                <div id="tenantCandidatesContent" class="mt-4"></div>
                <button type="button" class="btn btn-secondary mt-3" onclick="showDashboardScreen()">Back to Dashboard</button>
            </div>
        </div>

        <!-- Confirmation Screen -->
        <div id="confirmationScreen" class="hidden">
            <h2>Confirm Your Application</h2>
            <div id="confirmationContent" class="mt-4"></div>
            <button type="button" class="btn btn-primary" onclick="finalSubmitApplication()">Submit</button>
            <button type="button" class="btn btn-secondary" onclick="showPublicPropertyScreen()">Change</button>
        </div>

        <!-- Thank You Screen -->
        <div id="thankYouScreen" class="hidden">
            <div class="thank-you-screen">
                <h2>Thank You!</h2>
                <p id="thankYouMessage"></p>
                <button class="btn btn-primary" onclick="showPublicPropertyScreen()">Back to Property</button>
            </div>
        </div>

        <!-- Tenant Details Screen -->
        <div id="tenantDetailsScreen" class="hidden">
            <div class="dashboard-card p-0">
                <h2 class="mb-4 px-4 pt-4">Tenant Details</h2>
                <div id="tenantDetailsContent" class="mt-4 px-4"></div>
                <div class="text-center px-4 pb-4">
                    <button type="button" class="btn btn-secondary mt-3" onclick="backToTenantCandidatesScreen()">Back to Candidates</button>
                </div>
            </div>
        </div>
    </div>

    <div id="alertContainer" class="alert hidden" role="alert" style="position: fixed; top: 10px; right: 10px; z-index: 1050;"></div>
    <div id="overlay" class="d-none position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-25 justify-content-center align-items-center" style="z-index:2000;">
        <div class="spinner-border text-primary" role="status" style="width:3rem;height:3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <template id="tenantDetailsTemplate">
        <div class="tenant-details-card shadow-none border-0 px-0">
            <div class="tenant-details-header">
                <span id="candidateScoreBadge" class="badge">
                    Score: <span class="score-value"></span>
                </span>
            </div>
            <div class="details-section">
                <h3>Application Summary</h3>
                <div class="details-grid">
                    <div class="detail-item">
                        <div class="detail-label">Application Date</div>
                        <div class="detail-value" data-field="applicationDate"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Move-in Date</div>
                        <div class="detail-value" data-field="moveInDate"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Number of Occupants</div>
                        <div class="detail-value" data-field="occupants"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Smokers</div>
                        <div class="detail-value" data-field="smokers"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Pets</div>
                        <div class="detail-value" data-field="pets"></div>
                    </div>
                    <div class="detail-item pet-details-item" style="display:none;">
                        <div class="detail-label">Pet Details</div>
                        <div class="detail-value" data-field="petDetails"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Vehicles</div>
                        <div class="detail-value" data-field="vehicles"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Special Vehicles</div>
                        <div class="detail-value" data-field="specialVehicles"></div>
                    </div>
                    <div class="detail-item special-vehicles-details-item" style="display:none;">
                        <div class="detail-label">Special Vehicles Details</div>
                        <div class="detail-value" data-field="specialVehiclesDetails"></div>
                    </div>
                </div>
            </div>
            <div class="details-section">
                <h3>Rental History</h3>
                <div class="details-grid">
                    <div class="detail-item">
                        <div class="detail-label">Current Housing</div>
                        <div class="detail-value" data-field="housingSituation"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Residence Duration</div>
                        <div class="detail-value" data-field="residenceDuration"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Reason for Moving</div>
                        <div class="detail-value" data-field="reasonForMoving"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Private Landlord Before?</div>
                        <div class="detail-value" data-field="privateLandlord"></div>
                    </div>
                    <div class="detail-item rental-units-item" style="display:none;">
                        <div class="detail-label">Rental Units (last 5y)</div>
                        <div class="detail-value" data-field="rentalUnits"></div>
                    </div>
                    <div class="detail-item rent-difficulty-item" style="display:none;">
                        <div class="detail-label">Rent Difficulty</div>
                        <div class="detail-value" data-field="rentDifficulty"></div>
                    </div>
                    <div class="detail-item rent-difficulty-details-item" style="display:none;">
                        <div class="detail-label">Rent Difficulty Details</div>
                        <div class="detail-value" data-field="rentDifficultyDetails"></div>
                    </div>
                    <div class="detail-item tenancy-notice-item" style="display:none;">
                        <div class="detail-label">Tenancy Notice</div>
                        <div class="detail-value" data-field="tenancyNotice"></div>
                    </div>
                    <div class="detail-item tenancy-notice-details-item" style="display:none;">
                        <div class="detail-label">Tenancy Notice Details</div>
                        <div class="detail-value" data-field="tenancyNoticeDetails"></div>
                    </div>
                    <div class="detail-item rental-dispute-item" style="display:none;">
                        <div class="detail-label">Rental Dispute</div>
                        <div class="detail-value" data-field="rentalDispute"></div>
                    </div>
                    <div class="detail-item rental-dispute-details-item" style="display:none;">
                        <div class="detail-label">Rental Dispute Details</div>
                        <div class="detail-value" data-field="rentalDisputeDetails"></div>
                    </div>
                </div>
            </div>
            <div class="details-section">
                <h3>Employment & Income</h3>
                <div class="details-grid">
                    <div class="detail-item">
                        <div class="detail-label">Employment Status</div>
                        <div class="detail-value" data-field="employmentStatus"></div>
                    </div>
                    <div class="detail-item profession-item" style="display:none;">
                        <div class="detail-label">Profession / Field</div>
                        <div class="detail-value" data-field="profession"></div>
                    </div>
                    <div class="detail-item employment-duration-item" style="display:none;">
                        <div class="detail-label">Employment Duration</div>
                        <div class="detail-value" data-field="employmentDuration"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Gross Monthly Income</div>
                        <div class="detail-value" data-field="grossIncome"></div>
                    </div>
                </div>
            </div>
            <div class="details-section">
                <h3>Business & Other</h3>
                <div class="details-grid">
                    <div class="detail-item">
                        <div class="detail-label">Business Activity</div>
                        <div class="detail-value" data-field="businessActivity"></div>
                    </div>
                    <div class="detail-item business-activity-details-item" style="display:none;">
                        <div class="detail-label">Business Activity Details</div>
                        <div class="detail-value" data-field="businessActivityDetails"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Consent to Credit/Background Check</div>
                        <div class="detail-value" data-field="creditConsent"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Additional Info</div>
                        <div class="detail-value" data-field="additionalInfo"></div>
                    </div>
                </div>
            </div>
            <div class="details-section">
                <h3>Declarations</h3>
                <div class="details-grid">
                    <div class="detail-item">
                        <div class="detail-label">Declaration: Info is True</div>
                        <div class="detail-value" data-field="declaration1"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Declaration: No False Info</div>
                        <div class="detail-value" data-field="declaration2"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Consent to Contact</div>
                        <div class="detail-value" data-field="consentContact"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Consent to News</div>
                        <div class="detail-value" data-field="consentNews"></div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <template id="tenantCandidateRowTemplate">
        <tr>
            <td data-label="Move-In Date"></td>
            <td data-label="Occupants"></td>
            <td data-label="Employment Status" class="d-none d-md-table-cell"></td>
            <td data-label="Profession" class="d-none d-lg-table-cell"></td>
            <td data-label="Gross Income" class="d-none d-lg-table-cell"></td>
            <td data-label="Vehicles" class="d-none d-md-table-cell"></td>
            <td data-label="Score"></td>
            <td data-label="Application Date" class="d-none d-md-table-cell"></td>
            <td data-label="Details">
                <a href="javascript:void(0)">View</a>
            </td>
        </tr>
    </template>

    <script>
        const baseUrl = `${window.location.origin}`;

        // Store logged-in user info in localStorage for persistence across refreshes
        let currentUser = null;

        function saveCurrentUser(user) {
            currentUser = user;
            if (user && user.userId) {
                localStorage.setItem('currentUser', JSON.stringify(user));
            } else {
                localStorage.removeItem('currentUser');
            }
        }

        function loadCurrentUser() {
            try {
                const user = JSON.parse(localStorage.getItem('currentUser'));
                if (user && user.userId) {
                    currentUser = user;
                } else {
                    currentUser = null;
                }
            } catch (e) {
                currentUser = null;
            }
        }

        // Call this at the top of your script or before any screen logic
        loadCurrentUser();

        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alertContainer');
            alertContainer.textContent = message;
            alertContainer.className = `alert alert-${type}`;
            alertContainer.classList.remove('hidden');

            setTimeout(() => {
                alertContainer.classList.add('hidden');
            }, 3000); // Disappear after 3 seconds
        }

        function showOverlay() {
            const overlay = document.getElementById('overlay');
            overlay.classList.remove('d-none');
            overlay.classList.add('d-flex');
        }

        function hideOverlay() {
            const overlay = document.getElementById('overlay');
            overlay.classList.remove('d-flex');
            overlay.classList.add('d-none');
        }

        function fetchWithOverlay(url, options) {
            showOverlay();
            return fetch(url, options).finally(hideOverlay);
        }

        function register() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const termsCheck = document.getElementById('termsCheck').checked;

            // Client-side validation
            if (!email || !password || !confirmPassword || !termsCheck || password !== confirmPassword) {
                document.getElementById('registerForm').classList.add('was-validated');
                return;
            }

            // Simulate captcha validation (replace with actual captcha logic)
            const captchaValid = true;
            if (!captchaValid) {
                showAlert('Captcha validation failed.', 'danger');
                return;
            }

            // Send data to the server
            showOverlay();
            fetch(baseUrl + '/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('A confirmation email has been sent to your email address. Please check your inbox.');
                    showConfirmEmailScreen();
                } else {
                    showAlert(data.message || 'Registration failed.', 'danger');
                }
            })
            .catch(error => showAlert('An error occurred: ' + error.message, 'danger'))
            .finally(hideOverlay);
        }

        function handleConfirmEmail() {
            const email = document.getElementById('confirmEmailInput').value;
            const confirmationCode = document.getElementById('confirmationCode').value;

            // Client-side validation
            if (!email || !confirmationCode) {
                document.getElementById('confirmEmailForm').classList.add('was-validated');
                return;
            }

            // Send data to the server
            showOverlay();
            fetch(baseUrl + '/confirm-email', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, confirmationCode: confirmationCode.toLowerCase() })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Email confirmed!');
                    showLoginScreen();
                } else {
                    showAlert(data.message || 'Confirmation failed.', 'danger');
                }
            })
            .catch(error => showAlert('An error occurred: ' + error.message, 'danger'))
            .finally(hideOverlay);
        }

        function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            // Client-side validation
            if (!email || !password) {
                document.getElementById('loginForm').classList.add('was-validated');
                return;
            }

            // Send data to the server
            showOverlay();
            fetch(baseUrl + '/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Store user info (email and userId)
                    saveCurrentUser({ email, userId: data.userId });
                    showAlert('Login successful!');
                    showDashboardScreen();
                } else {
                    showAlert(data.message || 'Login failed.', 'danger');
                }
            })
            .catch(error => showAlert('An error occurred: ' + error.message, 'danger'))
            .finally(hideOverlay);
        }

        function sendResetCode() {
            const email = document.getElementById('forgotEmail').value;

            // Client-side validation
            if (!email) {
                document.getElementById('forgotPasswordForm').classList.add('was-validated');
                return;
            }

            // Send data to the server
            showOverlay();
            fetch(baseUrl + '/forgot-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Reset code sent to your email.');
                    showResetPasswordScreen();
                } else {
                    showAlert(data.message || 'Failed to send reset code.', 'danger');
                }
            })
            .catch(error => showAlert('An error occurred: ' + error.message, 'danger'))
            .finally(hideOverlay);
        }

        function resetPassword() {
            const email = document.getElementById('resetEmail').value;
            const resetCode = document.getElementById('resetCode').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;

            // Client-side validation
            if (!email || !resetCode || !newPassword || !confirmNewPassword) {
                document.getElementById('resetPasswordForm').classList.add('was-validated');
                return;
            }

            if (newPassword !== confirmNewPassword) {
                showAlert('Passwords do not match. Please try again.', 'danger');
                return;
            }

            // Send data to the server
            showOverlay();
            fetch(baseUrl + '/reset-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, resetCode, newPassword })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Password reset successful!');
                    showLoginScreen();
                } else {
                    showAlert(data.message || 'Failed to reset password.', 'danger');
                }
            })
            .catch(error => showAlert('An error occurred: ' + error.message, 'danger'))
            .finally(hideOverlay);
        }

        function showLoginScreen() {
            hideAllScreens();
            document.getElementById('loginScreen').classList.remove('hidden');
            if (history.state?.screen !== 'login') {
                history.pushState({ screen: 'login' }, '', '#login');
            }
        }

        function showRegisterScreen() {
            hideAllScreens();
            document.getElementById('registerScreen').classList.remove('hidden');
            if (history.state?.screen !== 'register') {
                history.pushState({ screen: 'register' }, '', '#register');
            }
        }

        function showForgotPasswordScreen() {
            hideAllScreens();
            document.getElementById('forgotPasswordScreen').classList.remove('hidden');
            if (history.state?.screen !== 'forgotPassword') {
                history.pushState({ screen: 'forgotPassword' }, '', '#forgotPassword');
            }
        }

        function showConfirmEmailScreen() {
            hideAllScreens();
            document.getElementById('confirmEmailScreen').classList.remove('hidden');
            if (history.state?.screen !== 'confirmEmail') {
                history.pushState({ screen: 'confirmEmail' }, '', '#confirmEmail');
            }
        }

        function showResetPasswordScreen() {
            hideAllScreens();
            document.getElementById('resetPasswordScreen').classList.remove('hidden');
            if (history.state?.screen !== 'resetPassword') {
                history.pushState({ screen: 'resetPassword' }, '', '#resetPassword');
            }
        }

        function showDashboardScreen() {
            hideAllScreens();
            document.getElementById('dashboardScreen').classList.remove('hidden');
            // Update browser history and hash for back/reload support
            if (history.state?.screen !== 'dashboard') {
                history.pushState({ screen: 'dashboard' }, '', '#dashboard');
            }
            fetchProperties();
        }

        function showAddPropertyScreen(editId = null) {
            hideAllScreens();
            document.getElementById('addPropertyScreen').classList.remove('hidden');
            document.getElementById('addPropertyForm').reset();
            document.getElementById('addPropertyForm').classList.remove('was-validated');
            document.getElementById('propertyFormTitle').textContent = editId ? 'Edit Property' : 'Add New Property';
            document.getElementById('property_id').value = editId || '';
            if (editId) {
                showOverlay();
                fetch(baseUrl + `/get-property?id=${encodeURIComponent(editId)}`, { method: 'GET' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const prop = data;
                            document.getElementById('property_address').value = prop.address || '';
                            document.getElementById('property_description').value = prop.description || '';
                            document.getElementById('property_link').value = prop.link || '';
                            document.getElementById('property_availability').value = prop.availability ? prop.availability.slice(0, 10) : '';
                            document.getElementById('property_rent').value = prop.rent || '';
                        } else {
                            showAlert(data.message || 'Failed to load property details.', 'danger');
                        }
                    })
                    .catch(error => showAlert('An error occurred: ' + error.message, 'danger'))
                    .finally(hideOverlay);
            }
            // Update browser history and hash for back/reload support
            const expectedScreen = editId ? 'editProperty' : 'addProperty';
            const expectedHash = editId ? `#editProperty/${encodeURIComponent(editId)}` : '#addProperty';
            if (history.state?.screen !== expectedScreen || (editId && history.state?.propertyId !== editId)) {
                history.pushState(
                    editId ? { screen: 'editProperty', propertyId: editId } : { screen: 'addProperty' },
                    '',
                    expectedHash
                );
            }
        }

        function editProperty(id) {
            showAddPropertyScreen(id);
        }

        function saveProperty() {
            const id = document.getElementById('property_id').value;
            const address = document.getElementById('property_address').value;
            const description = document.getElementById('property_description').value;
            const link = document.getElementById('property_link').value;
            const availability = document.getElementById('property_availability').value;
            const rent = document.getElementById('property_rent').value;

            // Validate required fields
            if (!address || !description || !availability || !rent) {
                document.getElementById('addPropertyForm').classList.add('was-validated');
                return;
            }

            // Validate availability date is not in the past
            const today = new Date().toISOString().split('T')[0];
            if (availability < today) {
                showAlert('Availability date cannot be in the past.', 'danger');
                return;
            }

            // Validate link if provided
            if (link && !isValidURL(link)) {
                showAlert('Please provide a valid URL for the link.', 'danger');
                return;
            }

            showOverlay();
            fetch(baseUrl + (id ? '/edit-property' : '/add-property'), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    id,
                    ownerId: currentUser && currentUser.userId,
                    address,
                    description,
                    link,
                    availability,
                    rent
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.prompt) {
                        showAlert(data.prompt, 'warning');
                    } else {
                        showAlert(id ? 'Property updated!' : 'Property added!');
                    }
                    showDashboardScreen();
                } else {
                    showAlert(data.message || 'Failed to save property.', 'danger');
                }
            })
            .catch(error => showAlert('An error occurred: ' + error.message, 'danger'))
            .finally(hideOverlay);
        }

        function isValidURL(url) {
            try {
                new URL(url);
                return true;
            } catch (_) {
                return false;
            }
        }

        function updatePropertyStatus(action, id, ownerId, successMessage, errorMessage) {
            showOverlay();
            fetch(baseUrl + `/${action}-property`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id, ownerId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert(successMessage);
                    fetchProperties();
                } else {
                    showAlert(data.message || errorMessage, 'danger');
                }
            })
            .catch(error => showAlert('An error occurred: ' + error.message, 'danger'))
            .finally(hideOverlay);
        }

        function deleteProperty(id) {
            if (!confirm('Are you sure you want to delete this property? This cannot be undone.')) return;
            updatePropertyStatus('delete', id, currentUser && currentUser.userId, 'Property deleted!', 'Could not delete property.');
        }

        function activateProperty(id) {
            updatePropertyStatus('activate', id, currentUser && currentUser.userId, 'Property activated!', 'Could not activate property.');
        }

        function deactivateProperty(id) {
            updatePropertyStatus('deactivate', id, currentUser && currentUser.userId, 'Property deactivated!', 'Could not deactivate property.');
        }

        function fetchProperties() {
            showOverlay();
            const params = new URLSearchParams({
                ownerId: currentUser && currentUser.userId
            });
            fetch(baseUrl + '/list-properties?' + params.toString(), {
                method: 'GET'
            })
            .then(response => response.json())
            .then(data => {
                renderProperties(data.properties || []);
                updateUsageMeter(data.activeCount || 0, data.maxActive || 1);
            })
            .catch(error => showAlert('An error occurred: ' + error.message, 'danger'))
            .finally(hideOverlay);
        }

        function updateUsageMeter(activeCount, maxActive) {
            const usageMeter = document.getElementById('usageMeter');
            if (usageMeter) {
                usageMeter.textContent = `${activeCount} of ${maxActive} active listings used`;
                usageMeter.className = `badge ${activeCount >= maxActive ? 'bg-danger' : 'bg-info'} text-dark align-self-start align-self-sm-center mt-2 mt-sm-0`;
            }
        }

        function renderProperties(properties) {
            const tbody = document.getElementById('propertiesTableBody');
            if (tbody) {
                tbody.innerHTML = '';
                properties.forEach(prop => {
                    const isActive = prop.status === 'Active';
                    const publicUrl = `${window.location.origin + window.location.pathname}#publicProperty?id=${prop.id}`;
                    const activateBtn = isActive
                        ? `<button class="btn btn-sm btn-outline-secondary" title="Deactivate" onclick="deactivateProperty('${prop.id}')">
                                <i class="bi bi-toggle2-on"></i>
                                <span class="visually-hidden">Deactivate</span>
                           </button>`
                        : `<button class="btn btn-sm btn-outline-success" title="Activate" onclick="activateProperty('${prop.id}')">
                                <i class="bi bi-toggle2-off"></i>
                                <span class="visually-hidden">Activate</span>
                           </button>`;
                    const copyBtn = `<button class="btn btn-sm btn-outline-primary me-1 ${isActive ? 'active bg-success' : ''}" title="Copy Link" onclick="copyLink('${publicUrl}')" ${!isActive ? 'disabled' : ''}>
                                    <i class="bi bi-clipboard"></i>
                                    <span class="visually-hidden">Copy Link</span>
                                 </button>`;
                    const deleteBtn = `<button class="btn btn-sm btn-outline-danger" title="Delete" onclick="deleteProperty('${prop.id}')">
                                    <i class="bi bi-trash"></i>
                                    <span class="visually-hidden">Delete</span>
                                   </button>`;
                    const candidatesLink = `<a href="javascript:void(0)" onclick="showTenantCandidatesScreen('${prop.id}')">${prop.candidatesCount || 0}</a>`;
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="text-break">
                            <i class="bi bi-pencil-square text-primary me-2" role="button" title="Edit" onclick="editProperty('${prop.id}')"></i>
                            <a href="javascript:void(0)" onclick="editProperty('${prop.id}')">${prop.address}</a>
                        </td>
                        <td>
                            <span class="badge ${isActive ? 'bg-success' : 'bg-secondary'}">${prop.status}</span>
                        </td>
                        <td>${candidatesLink}</td>
                        <td class="text-end d-none d-sm-table-cell">
                            <div class="d-flex dashboard-actions justify-content-end">
                                ${activateBtn}
                                ${copyBtn}
                                ${deleteBtn}
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        }

        function backToTenantCandidatesScreen(){
            const propertyId = document.getElementById('tenantDetailsScreen').getAttribute('data-property-id');
            showTenantCandidatesScreen(propertyId);
        }

        function showTenantCandidatesScreen(propertyId) {
            hideAllScreens();
            document.getElementById('tenantCandidatesScreen').classList.remove('hidden');
            const container = document.getElementById('tenantCandidatesContent');
            container.innerHTML = ''; // Clear previous content
            showOverlay();
            fetch(`${baseUrl}/get-tenant-candidates?propertyId=${encodeURIComponent(propertyId)}`)
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        container.innerHTML = `<div class="alert alert-danger">${data.message || 'Failed to load tenant candidates.'}</div>`;
                    } else if (data.candidates.length === 0) {
                        container.innerHTML = `<div class="alert alert-warning">No tenant candidates found for this property.</div>`;
                    } else {
                        const table = document.createElement('table');
                        table.classList.add('table', 'table-hover', 'align-middle', 'w-100');
                        table.innerHTML = `
                            <thead>
                                <tr>
                                    <th>Move-In Date</th>
                                    <th>Occupants</th>
                                    <th class="d-none d-md-table-cell">Employment Status</th>
                                    <th class="d-none d-lg-table-cell">Profession</th>
                                    <th class="d-none d-lg-table-cell">Gross Income</th>
                                    <th class="d-none d-md-table-cell">Vehicles</th>
                                    <th>Score</th>
                                    <th class="d-none d-md-table-cell">Application Date</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        `;
                        const tbody = table.querySelector('tbody');
                        const rowTemplate = document.getElementById('tenantCandidateRowTemplate');
                        data.candidates.forEach(candidate => {
                            const row = rowTemplate.content.cloneNode(true);
                            const tds = row.querySelectorAll('td');
                            tds[0].textContent = candidate.moveInDate || '';
                            tds[1].textContent = candidate.occupants || '';
                            tds[2].textContent = candidate.employmentStatus || '';
                            tds[3].textContent = candidate.profession || '';
                            tds[4].textContent = candidate.grossIncome || '';
                            tds[5].textContent = candidate.vehicles || '';
                            tds[6].textContent = candidate.score !== undefined && candidate.score !== null ? candidate.score : '';
                            tds[7].textContent = candidate.applicationDate || '';
                            // Details link
                            const detailsLink = tds[8].querySelector('a');
                            detailsLink.onclick = () => showTenantDetailsScreen(candidate.id);
                            tbody.appendChild(row);
                        });
                        container.appendChild(table);
                    }
                })
                .catch(() => {
                    container.innerHTML = `<div class="alert alert-danger">Error loading tenant candidates.</div>`;
                })
                .finally(hideOverlay);

            // Update browser history and hash for back/reload support
            if (history.state?.screen !== 'tenantCandidates' || history.state?.propertyId !== propertyId) {
                history.pushState({ screen: 'tenantCandidates', propertyId }, '', `#tenantCandidates/${encodeURIComponent(propertyId)}`);
            }
        }

        function showTenantDetailsScreen(candidateId) {
            hideAllScreens();
            document.getElementById('tenantDetailsScreen').classList.remove('hidden');

            showOverlay();
            fetch(`${baseUrl}/get-tenant-candidate-details?id=${encodeURIComponent(candidateId)}`)
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                                               showAlert(data.message || 'Failed to load tenant details.', 'danger');
                        return;
                    }

                    const candidate = data.candidate;
                    const content = document.getElementById('tenantDetailsContent');
                    const template = document.getElementById('tenantDetailsTemplate');
                    content.innerHTML = '';
                    if (template) {
                        const node = template.content.cloneNode(true);

                        // Score badge
                        const badge = node.querySelector('#candidateScoreBadge');
                        if (badge) {
                            badge.className = `badge ${getScoreBadgeClass(candidate.score)}`;
                            badge.querySelector('.score-value').textContent = candidate.score || 'N/A';
                        }

                        // Helper for boolean display
                        function boolDisplay(val) {
                            if (typeof val === 'boolean') return val ? 'Yes' : 'No';
                            if (val === true || val === 'true' || val === 'Yes') return 'Yes';
                            if (val === false || val === 'false' || val === 'No') return 'No';
                            return val || 'N/A';
                        }

                        // Fill all data-fields
                        node.querySelectorAll('[data-field]').forEach(el => {
                            const field = el.getAttribute('data-field');
                            let val = candidate[field];

                            // Special handling for booleans and checkboxes
                            if (['declaration1', 'declaration2', 'consentContact', 'consentNews'].includes(field)) {
                                el.textContent = boolDisplay(val);
                            } else if (field === 'pets' && !val) {
                                el.textContent = 'No';
                            } else if (field === 'moveInDate' && !val && candidate.moveindate) {
                                el.textContent = candidate.moveindate;
                            } else if (field === 'applicationDate' && !val && candidate.applicationdate) {
                                el.textContent = candidate.applicationdate;
                            } else {
                                el.textContent = val || 'N/A';
                            }
                        });

                        // Show/hide details based on candidate data
                        if (candidate.petDetails) {
                            const petDetailsItem = node.querySelector('.pet-details-item');
                            if (petDetailsItem) petDetailsItem.style.display = '';
                        }
                        if (candidate.specialVehiclesDetails) {
                            const specialVehiclesDetailsItem = node.querySelector('.special-vehicles-details-item');
                            if (specialVehiclesDetailsItem) specialVehiclesDetailsItem.style.display = '';
                        }
                        if (candidate.privateLandlord === 'Yes') {
                            const rentalUnitsItem = node.querySelector('.rental-units-item');
                            if (rentalUnitsItem) rentalUnitsItem.style.display = '';
                        }
                        if (candidate.rentDifficulty) {
                            const rentDifficultyItem = node.querySelector('.rent-difficulty-item');
                            if (rentDifficultyItem) rentDifficultyItem.style.display = '';
                        }
                        if (candidate.rentDifficultyDetails) {
                            const rentDifficultyDetailsItem = node.querySelector('.rent-difficulty-details-item');
                            if (rentDifficultyDetailsItem) rentDifficultyDetailsItem.style.display = '';
                        }
                        if (candidate.tenancyNotice) {
                            const tenancyNoticeItem = node.querySelector('.tenancy-notice-item');
                            if (tenancyNoticeItem) tenancyNoticeItem.style.display = '';
                        }
                        if (candidate.tenancyNoticeDetails) {
                            const tenancyNoticeDetailsItem = node.querySelector('.tenancy-notice-details-item');
                            if (tenancyNoticeDetailsItem) tenancyNoticeDetailsItem.style.display = '';
                        }
                        if (candidate.rentalDispute) {
                            const rentalDisputeItem = node.querySelector('.rental-dispute-item');
                            if (rentalDisputeItem) rentalDisputeItem.style.display = '';
                        }
                        if (candidate.rentalDisputeDetails) {
                            const rentalDisputeDetailsItem = node.querySelector('.rental-dispute-details-item');
                            if (rentalDisputeDetailsItem) rentalDisputeDetailsItem.style.display = '';
                        }
                        if (candidate.profession) {
                            const professionItem = node.querySelector('.profession-item');
                            if (professionItem) professionItem.style.display = '';
                        }
                        if (candidate.employmentDuration) {
                            const employmentDurationItem = node.querySelector('.employment-duration-item');
                            if (employmentDurationItem) employmentDurationItem.style.display = '';
                        }
                        if (candidate.businessActivityDetails) {
                            const businessActivityDetailsItem = node.querySelector('.business-activity-details-item');
                            if (businessActivityDetailsItem) businessActivityDetailsItem.style.display = '';
                        }

                        content.appendChild(node);
                    }

                    // Store propertyId for back navigation (prefer candidate.propertyId if available)
                    document.getElementById('tenantDetailsScreen').setAttribute('data-property-id', candidate.propertyid);
                })
                .catch(error => {
                    showAlert('Error loading tenant details: ' + error.message, 'danger');
                })
                .finally(hideOverlay);

            // Update browser history and hash for back/reload support
            if (history.state?.screen !== 'tenantDetails' || history.state?.candidateId !== candidateId) {
                history.pushState({ screen: 'tenantDetails', candidateId }, '', `#tenantDetails/${encodeURIComponent(candidateId)}`);
            }
        }

        function getScoreBadgeClass(score) {
            if (!score) return 'bg-secondary';
            if (score >= 90) return 'bg-success';
            if (score >= 70) return 'bg-info';
            if (score >= 50) return 'bg-warning';
            return 'bg-danger';
        }

        function getPropertyId(){
            const hash = window.location.hash;
            // REST-style: #publicProperty/abc
            if (hash.startsWith('#publicProperty/')) {
                return hash.split('/')[1];
            }
            // fallback for old style (should not be needed after migration)
            const params = new URLSearchParams(hash.split('?')[1]);
            return params.get('id');
        }

        // --- Public Property View ---
        function showPublicPropertyScreen() {
            const propertyId = getPropertyId();
            if (!propertyId) {
                return false;
            }
            
            hideAllScreens();
            const screen = document.getElementById('publicPropertyScreen');
            if (screen) {
                screen.classList.remove('hidden');
            }
            const container = document.getElementById('publicPropertyContent');
            if (container) {
                container.innerHTML = ''; // Clear previous content
            }
            showOverlay();
            fetch(baseUrl + '/get-property?id=' + encodeURIComponent(propertyId), { method: 'GET' })
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        container.innerHTML = `<div class="alert alert-danger">${data.message || 'Property not found.'}</div>`;
                    } else {
                        container.innerHTML = `
                            <div class="card">
                                <div class="card-body">
                                    <h4 class="card-title">${data.address}</h4>
                                    <p class="card-text">${data.description}</p>
                                    ${data.link ? `<p class="card-text"><a href="${data.link}" target="_blank">View Listing</a></p>` : ''}
                                    <p class="card-text"><small class="text-muted">Available: ${data.availability ? data.availability.slice(0, 10) : 'N/A'}</small></p>
                                </div>
                            </div>
                        `;
                    }
                })
                .catch(() => {
                    container.innerHTML = `<div class="alert alert-danger">Error loading property.</div>`;
                })
                .finally(hideOverlay);

            return true;
        }

        function logout() {
            saveCurrentUser(null);
            showLoginScreen();
            showAlert('Logged out successfully.', 'info');
        }

        function hideAllScreens() {
            // Ensure all screens are hidden
            const screens = [
                'loginScreen', 'registerScreen', 'forgotPasswordScreen', 
                'confirmEmailScreen', 'resetPasswordScreen', 'dashboardScreen', 
                'addPropertyScreen', 'publicPropertyScreen', 'tenantCandidatesScreen',
                'confirmationScreen', 'thankYouScreen', 'tenantDetailsScreen'
            ];
            screens.forEach(screenId => {
                const screen = document.getElementById(screenId);
                if (screen) {
                    screen.classList.add('hidden');
                }
            });
        }

        // Handle browser back button
        window.onpopstate = function (event) {
            if (event.state) {
                handleScreen(event.state.screen);
            } else {
                handleHashOrDefault();
            }
        };

        function handleScreen(screen) {
            switch (screen) {
                case 'login':
                    showLoginScreen();
                    break;
                case 'register':
                    showRegisterScreen();
                    break;
                case 'forgotPassword':
                    showForgotPasswordScreen();
                    break;
                case 'confirmEmail':
                    showConfirmEmailScreen();
                    break;
                case 'resetPassword':
                    showResetPasswordScreen();
                    break;
                case 'dashboard':
                    showDashboardScreen();
                    break;
                case 'addProperty':
                    showAddPropertyScreen();
                    break;
                case 'editProperty': {
                    // Try to get propertyId from state or hash
                    let propertyId = history.state?.propertyId;
                    if (!propertyId) {
                        const hash = window.location.hash;
                        // REST-style: #editProperty/abc
                        if (hash.startsWith('#editProperty/')) {
                            propertyId = hash.split('/')[1];
                        }
                    }
                    showAddPropertyScreen(propertyId);
                    break;
                }
                case 'tenantDetails': {
                    // Try to get candidateId from state or hash
                    let candidateId = history.state?.candidateId;
                    if (!candidateId) {
                        const hash = window.location.hash;
                        // REST-style: #tenantDetails/abc
                        if (hash.startsWith('#tenantDetails/')) {
                            candidateId = hash.split('/')[1];
                        }
                    }
                    if (candidateId) showTenantDetailsScreen(candidateId);
                    else showDashboardScreen();
                    break;
                }
                case 'tenantCandidates': {
                    let propertyId = history.state?.propertyId;
                    if (!propertyId) {
                        const hash = window.location.hash;
                        // REST-style: #tenantCandidates/abc
                        if (hash.startsWith('#tenantCandidates/')) {
                            propertyId = hash.split('/')[1];
                        }
                    }
                    if (propertyId) showTenantCandidatesScreen(propertyId);
                    else showDashboardScreen();
                    break;
                }
                default:
                    showLoginScreen();
            }
        }

        function handleHashOrDefault() {
            const hash = window.location.hash;
            if (hash.startsWith('#resetPassword')) {
                // legacy: #resetPassword?email=...&code=...
                const params = new URLSearchParams(hash.split('?')[1]);
                const resetPasswordEmail = params.get('email');
                const resetPasswordCode = params.get('code');

                if (resetPasswordEmail && resetPasswordCode) {
                    document.getElementById('resetEmail').value = resetPasswordEmail;
                    document.getElementById('resetCode').value = resetPasswordCode;
                    showResetPasswordScreen();
                    return;
                }
            } else if (hash.startsWith('#confirmEmail')) {
                // legacy: #confirmEmail?email=...&code=...
                const params = new URLSearchParams(hash.split('?')[1]);
                const confirmEmail = params.get('email');
                const confirmCode = params.get('code');

                if (confirmEmail && confirmCode) {
                    document.getElementById('confirmEmailInput').value = confirmEmail;
                    document.getElementById('confirmationCode').value = confirmCode;
                    showConfirmEmailScreen();
                    return;
                }
            } else if (hash.startsWith('#publicProperty')) {
                if(showPublicPropertyScreen())
                    return;
            } else if (hash.startsWith('#tenantCandidates/')) {
                const propertyId = hash.split('/')[1];
                if (propertyId) {
                    showTenantCandidatesScreen(propertyId);
                    return;
                }
            } else if (hash.startsWith('#tenantDetails/')) {
                const candidateId = hash.split('/')[1];
                if (candidateId) {
                    showTenantDetailsScreen(candidateId);
                    return;
                }
            } else if (hash.startsWith('#dashboard')) {
                showDashboardScreen();
                return;
            } else if (hash.startsWith('#addProperty')) {
                showAddPropertyScreen();
                return;
            } else if (hash.startsWith('#editProperty/')) {
                const propertyId = hash.split('/')[1];
                showAddPropertyScreen(propertyId);
                return;
            }

            // Default to login screen if no valid hash
            showLoginScreen();
        }

        // On page load, handle hash or initialize default screen
        (function() {
            handleHashOrDefault();
        })();

        document.getElementById('loginForm').addEventListener('keypress', function (event) {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevent default form submission
                login(); // Trigger login function
            }
        });

        function copyLink(link) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(link)
                    .then(() => {
                        showAlert('Link copied to clipboard!', 'success');
                    })
                    .catch(() => {
                        showAlert('Failed to copy link.', 'danger');
                    });
            } else {
                const tempInput = document.createElement('input');
                tempInput.value = link;
                document.body.appendChild(tempInput);
                tempInput.select();
                try {
                    document.execCommand('copy');
                    showAlert('Link copied to clipboard!', 'success');
                } catch (error) {
                    showAlert('Failed to copy link.', 'danger');
                }
                document.body.removeChild(tempInput);
            }
        }

        // Validate move-in date to ensure it is not in the past
        document.getElementById('moveInDate').addEventListener('change', function () {
            const moveInDate = new Date(this.value);
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Reset time to midnight
            if (moveInDate < today) {
                this.setCustomValidity('Move-in date cannot be in the past.');
            } else {
                this.setCustomValidity('');
            }
        });

        // Centralized function to handle visibility logic
        function updateVisibility() {
            const pets = document.getElementById('pets');
            const petDetailsContainer = document.getElementById('petDetailsContainer');
            petDetailsContainer.style.display = (pets.value && pets.value !== 'No') ? 'block' : 'none';

            const privateLandlord = document.getElementById('privateLandlord');
            const rentalHistoryDetails = document.getElementById('rentalHistoryDetails');
            rentalHistoryDetails.style.display = privateLandlord.value === 'Yes' ? 'block' : 'none';

            const rentDifficulty = document.getElementById('rentDifficulty');
            const rentDifficultyDetailsContainer = document.getElementById('rentDifficultyDetailsContainer');
            rentDifficultyDetailsContainer.style.display = rentDifficulty.value === 'Yes' ? 'block' : 'none';

            const tenancyNotice = document.getElementById('tenancyNotice');
            const tenancyNoticeDetailsContainer = document.getElementById('tenancyNoticeDetailsContainer');
            tenancyNoticeDetailsContainer.style.display = tenancyNotice.value === 'Yes' ? 'block' : 'none';

            const rentalDispute = document.getElementById('rentalDispute');
            const rentalDisputeDetailsContainer = document.getElementById('rentalDisputeDetailsContainer');
            rentalDisputeDetailsContainer.style.display = rentalDispute.value === 'Yes' ? 'block' : 'none';

            const employmentStatus = document.getElementById('employmentStatus');
            const employmentDetails = document.getElementById('employmentDetails');
            employmentDetails.style.display = (employmentStatus.value && employmentStatus.value !== 'Unemployed' && employmentStatus.value !== 'Retired') ? 'block' : 'none';

            const businessActivity = document.getElementById('businessActivity');
            const businessActivityDetailsContainer = document.getElementById('businessActivityDetailsContainer');
            businessActivityDetailsContainer.style.display = businessActivity.value === 'Yes' ? 'block' : 'none';

            const specialVehicles = document.getElementById('specialVehicles');
            const specialVehiclesDetailsContainer = document.getElementById('specialVehiclesDetailsContainer');
            specialVehiclesDetailsContainer.style.display = specialVehicles.value === 'Yes — Other' ? 'block' : 'none';
        }

        // Attach event listeners for interaction
        function attachVisibilityListeners() {
            document.getElementById('pets').addEventListener('change', updateVisibility);
            document.getElementById('privateLandlord').addEventListener('change', updateVisibility);
            document.getElementById('rentDifficulty').addEventListener('change', updateVisibility);
            document.getElementById('tenancyNotice').addEventListener('change', updateVisibility);
            document.getElementById('rentalDispute').addEventListener('change', updateVisibility);
            document.getElementById('employmentStatus').addEventListener('change', updateVisibility);
            document.getElementById('businessActivity').addEventListener('change', updateVisibility);
            document.getElementById('specialVehicles').addEventListener('change', updateVisibility);
        }

        // Initialize visibility logic on page load
        document.addEventListener('DOMContentLoaded', () => {
            updateVisibility(); // Ensure visibility is correct on load
            attachVisibilityListeners(); // Attach listeners for interaction
        });

        function showThankYouScreen(message) {
            hideAllScreens();
            const thankYouScreen = document.getElementById('thankYouScreen');
            const thankYouMessage = document.getElementById('thankYouMessage');
            thankYouMessage.textContent = message;
            thankYouScreen.classList.remove('hidden');
        }

        function submitApplication() {
            const form = document.getElementById('applyForm');
            const errorsContainer = document.getElementById('applyFormErrors');
            errorsContainer.innerHTML = ''; // Clear previous errors
            errorsContainer.classList.add('hidden');

            const notHiddenFields = form.querySelectorAll(':not(.hidden) [required], :not(.hidden) [optional]');
            let isValid = true;
            const errorMessages = [];

            function isVisibleWithParent(field){
                return !!(field.offsetParent) 
            }

            notHiddenFields.forEach(field => {
                if (isVisibleWithParent(field) && !field.checkValidity()) {
                    isValid = false;
                    const label = form.querySelector(`label[for="${field.id}"]`);
                    errorMessages.push(label ? `${label.textContent.trim()}: ${field.validationMessage}` : field.validationMessage);
                }
            });


            if (!isValid) {
                errorsContainer.innerHTML = errorMessages.join('<br>');
                errorsContainer.classList.remove('hidden');
                return;
            }

            const data = {
                propertyId: getPropertyId(),
                email: document.getElementById('applicantEmail').value,
                consentContact: document.getElementById('consentContact').checked,
                consentNews: document.getElementById('consentNews').checked,
                moveInDate: document.getElementById('moveInDate').value,
                occupants: document.getElementById('occupants').value,
                smokers: document.getElementById('smokers').value,
                pets: document.getElementById('pets').value,
                petDetails: document.getElementById('petDetails').value || null,
                housingSituation: document.getElementById('housingSituation').value,
                residenceDuration: document.getElementById('residenceDuration').value,
                reasonForMoving: document.getElementById('reasonForMoving').value || null,
                privateLandlord: document.getElementById('privateLandlord').value,
                rentalUnits: document.getElementById('rentalUnits').value || null,
                rentDifficulty: document.getElementById('rentDifficulty').value || null,
                rentDifficultyDetails: document.getElementById('rentDifficultyDetails').value || null,
                tenancyNotice: document.getElementById('tenancyNotice').value || null,
                tenancyNoticeDetails: document.getElementById('tenancyNoticeDetails').value || null,
                rentalDispute: document.getElementById('rentalDispute').value || null,
                rentalDisputeDetails: document.getElementById('rentalDisputeDetails').value || null,
                grossIncome: document.getElementById('grossIncome').value,
                creditConsent: document.getElementById('creditConsent').value,
                employmentStatus: document.getElementById('employmentStatus').value,
                profession: document.getElementById('profession').value || null,
                employmentDuration: document.getElementById('employmentDuration').value || null,
                businessActivity: document.getElementById('businessActivity').value,
                businessActivityDetails: document.getElementById('businessActivityDetails').value || null,
                vehicles: document.getElementById('vehicles').value,
                specialVehicles: document.getElementById('specialVehicles').value,
                specialVehiclesDetails: document.getElementById('specialVehiclesDetails').value || null,
                additionalInfo: document.getElementById('additionalInfo').value || null,
                declaration1: document.getElementById('declaration1').checked,
                declaration2: document.getElementById('declaration2').checked,
            };

            showOverlay();
            fetch(baseUrl + '/apply', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showThankYouScreen(data.message);
                } else {
                    showAlert(data.message || 'Failed to submit application.', 'danger');
                }
            })
            .catch(error => showAlert('An error occurred: ' + error.message, 'danger'))
            .finally(hideOverlay);
        }

        // Restore minimum 5-character validation for required textareas
        document.querySelectorAll('textarea[required]').forEach(textarea => {
            textarea.addEventListener('input', function () {
                if (this.value.trim().length < 5) {
                    this.setCustomValidity('Please provide at least 5 characters.');
                } else {
                    this.setCustomValidity('');
                }
            });
        });
    </script>
</body>
</html>
